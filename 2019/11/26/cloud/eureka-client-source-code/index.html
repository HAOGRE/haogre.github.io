<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/function%20small()%20%7B%20%5Bnative%20code%5D%20%7D?v=5.1.4">






  <meta name="keywords" content="eco,微服务，springcloud," />










<meta name="description" content="基本功能 注册服务实例到Eureka Server中；  发送心跳更新与Eureka Server的租约；  在服务关闭时从Eureka Server中取消租约，服务下线；  查询在Eureka Server中注册的服务实例列表；   1）相关配置的赋值，类似ApplicationInfoManager、EurekaClientConfig等。   2）备份注册中心的初始化，默认没有实现。   3">
<meta property="og:type" content="article">
<meta property="og:title" content="eureka-client-source-code">
<meta property="og:url" content="http://yoursite.com/2019/11/26/cloud/eureka-client-source-code/index.html">
<meta property="og:site_name" content="HAOGRE&#39;s blog">
<meta property="og:description" content="基本功能 注册服务实例到Eureka Server中；  发送心跳更新与Eureka Server的租约；  在服务关闭时从Eureka Server中取消租约，服务下线；  查询在Eureka Server中注册的服务实例列表；   1）相关配置的赋值，类似ApplicationInfoManager、EurekaClientConfig等。   2）备份注册中心的初始化，默认没有实现。   3">
<meta property="article:published_time" content="2019-11-26T06:41:31.000Z">
<meta property="article:modified_time" content="2020-07-15T09:07:00.173Z">
<meta property="article:author" content="HAOGRE">
<meta property="article:tag" content="eco">
<meta property="article:tag" content="微服务，springcloud">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/26/cloud/eureka-client-source-code/"/>





  <title>eureka-client-source-code | HAOGRE's blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HAOGRE's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categoriesa%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-labs">
          <a href="/labs%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-flask"></i> <br />
            
            实验室
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/26/cloud/eureka-client-source-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HAOGRE">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jp">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HAOGRE's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">eureka-client-source-code</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-26T14:41:31+08:00">
                2019-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86/" itemprop="url" rel="index">
                    <span itemprop="name">看这一篇就够了</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2><ul>
<li><p>注册服务实例到Eureka Server中；</p>
</li>
<li><p>发送心跳更新与Eureka Server的租约；</p>
</li>
<li><p>在服务关闭时从Eureka Server中取消租约，服务下线；</p>
</li>
<li><p>查询在Eureka Server中注册的服务实例列表；</p>
<p>  1）相关配置的赋值，类似ApplicationInfoManager、EurekaClientConfig等。</p>
<p>  2）备份注册中心的初始化，默认没有实现。</p>
<p>  3）拉取Eureka Server注册表中的信息。</p>
<p>  4）注册前的预处理。</p>
<p>  5）向Eureka Server注册自身。</p>
<p>  6）初始化心跳定时任务、缓存刷新和按需注册等定时任务。</p>
</li>
</ul>
<a id="more"></a>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2012 Netflix, Inc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> *    you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> *    You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *        http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> *    distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> *    See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> *    limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.netflix.discovery;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.netflix.discovery.EurekaClientNames.METRIC_REGISTRATION_PREFIX;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.netflix.discovery.EurekaClientNames.METRIC_REGISTRY_PREFIX;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArraySet;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.SynchronousQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"><span class="keyword">import</span> javax.inject.Provider;</span><br><span class="line"><span class="keyword">import</span> javax.inject.Singleton;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.Response.Status;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.resolver.EndpointRandomizer;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.resolver.ResolverUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.annotations.VisibleForTesting;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Strings;</span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.ThreadFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> com.google.inject.Inject;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.ApplicationInfoManager;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.HealthCheckCallback;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.HealthCheckCallbackToHandlerBridge;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.HealthCheckHandler;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo.ActionType;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo.InstanceStatus;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.endpoint.EndpointUtils;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.Application;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.Applications;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.resolver.ClosableResolver;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.resolver.aws.ApplicationsResolver;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.EurekaHttpClient;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.EurekaHttpClientFactory;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.EurekaHttpClients;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.EurekaHttpResponse;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.EurekaTransportConfig;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.TransportClientFactory;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.jersey.EurekaJerseyClient;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.jersey.Jersey1DiscoveryClientOptionalArgs;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.jersey.Jersey1TransportClientFactories;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.shared.transport.jersey.TransportClientFactories;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.util.ThresholdLevelsMetric;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.annotations.DataSourceType;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.monitor.Counter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.monitor.Monitors;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.monitor.Stopwatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The class that is instrumental for interactions with &lt;tt&gt;Eureka Server&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;Eureka Client&lt;/tt&gt; is responsible for a) &lt;em&gt;Registering&lt;/em&gt; the</span></span><br><span class="line"><span class="comment"> * instance with &lt;tt&gt;Eureka Server&lt;/tt&gt; b) &lt;em&gt;Renewal&lt;/em&gt;of the lease with</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;Eureka Server&lt;/tt&gt; c) &lt;em&gt;Cancellation&lt;/em&gt; of the lease from</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;Eureka Server&lt;/tt&gt; during shutdown</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * d) &lt;em&gt;Querying&lt;/em&gt; the list of services/instances registered with</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;Eureka Server&lt;/tt&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;Eureka Client&lt;/tt&gt; needs a configured list of &lt;tt&gt;Eureka Server&lt;/tt&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> java.net.URL&#125;s to talk to.These &#123;<span class="doctag">@link</span> java.net.URL&#125;s are typically amazon elastic eips</span></span><br><span class="line"><span class="comment"> * which do not change. All of the functions defined above fail-over to other</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> java.net.URL&#125;s specified in the list in the case of failure.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Karthik Ranganathan, Greg Kim</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DiscoveryClient<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_X_DISCOVERY_ALLOW_REDIRECT = <span class="string">"X-Discovery-AllowRedirect"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALUE_DELIMITER = <span class="string">","</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COMMA_STRING = VALUE_DELIMITER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> here for legacy support as the client config has moved to be an instance variable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EurekaClientConfig staticClientConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timers</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"DiscoveryClient_"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter RECONCILE_HASH_CODES_MISMATCH = Monitors.newCounter(PREFIX + <span class="string">"ReconcileHashCodeMismatch"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> com.netflix.servo.monitor.Timer FETCH_REGISTRY_TIMER = Monitors</span><br><span class="line">            .newTimer(PREFIX + <span class="string">"FetchRegistry"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter REREGISTER_COUNTER = Monitors.newCounter(PREFIX</span><br><span class="line">            + <span class="string">"Reregister"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// instance variables</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A scheduler to be used for the following 3 tasks:</span></span><br><span class="line"><span class="comment">     * - updating service urls</span></span><br><span class="line"><span class="comment">     * - scheduling a TimedSuperVisorTask</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">    <span class="comment">// additional executors for supervised subtasks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;HealthCheckHandler&gt; healthCheckHandlerProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;HealthCheckCallback&gt; healthCheckCallbackProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PreRegistrationHandler preRegistrationHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock fetchRegistryUpdateLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// monotonically increasing generation counter to ensure stale threads do not reset registry to an older version</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong fetchRegistryGeneration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo instanceInfo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; remoteRegionsToFetch;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String[]&gt; remoteRegionsRef;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceRegionChecker instanceRegionChecker;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EndpointUtils.ServiceUrlRandomizer urlRandomizer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EndpointRandomizer endpointRandomizer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;BackupRegistry&gt; backupRegistryProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaTransport eurekaTransport;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;HealthCheckHandler&gt; healthCheckHandlerRef = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, Applications&gt; remoteRegionVsApps = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.InstanceStatus lastRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;EurekaEventListener&gt; eventListeners = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appPathIdentifier;</span><br><span class="line">    <span class="keyword">private</span> ApplicationInfoManager.StatusChangeListener statusChangeListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InstanceInfoReplicator instanceInfoReplicator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> registrySize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric heartbeatStalenessMonitor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric registryStalenessMonitor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaTransportConfig transportConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> initTimestampMs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaTransport</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ClosableResolver bootstrapResolver;</span><br><span class="line">        <span class="keyword">private</span> TransportClientFactory transportClientFactory;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> EurekaHttpClient registrationClient;</span><br><span class="line">        <span class="keyword">private</span> EurekaHttpClientFactory registrationClientFactory;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> EurekaHttpClient queryClient;</span><br><span class="line">        <span class="keyword">private</span> EurekaHttpClientFactory queryClientFactory;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (registrationClientFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                registrationClientFactory.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (queryClientFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                queryClientFactory.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (registrationClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                registrationClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (queryClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                queryClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (transportClientFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                transportClientFactory.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bootstrapResolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bootstrapResolver.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Assumes applicationInfoManager is already initialized</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use constructor that takes ApplicationInfoManager instead of InstanceInfo directly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(InstanceInfo myInfo, EurekaClientConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(myInfo, config, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Assumes applicationInfoManager is already initialized</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use constructor that takes ApplicationInfoManager instead of InstanceInfo directly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(InstanceInfo myInfo, EurekaClientConfig config, DiscoveryClientOptionalArgs args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(ApplicationInfoManager.getInstance(), config, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use constructor that takes ApplicationInfoManager instead of InstanceInfo directly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(InstanceInfo myInfo, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(ApplicationInfoManager.getInstance(), config, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(applicationInfoManager, config, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use the version that take &#123;<span class="doctag">@link</span> com.netflix.discovery.AbstractDiscoveryClientOptionalArgs&#125; instead</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">final</span> EurekaClientConfig config, DiscoveryClientOptionalArgs args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(applicationInfoManager, config, (AbstractDiscoveryClientOptionalArgs) args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">final</span> EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(applicationInfoManager, config, args, ResolverUtils::randomize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClient</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">final</span> EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args, EndpointRandomizer randomizer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(applicationInfoManager, config, args, <span class="keyword">new</span> Provider&lt;BackupRegistry&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">volatile</span> BackupRegistry backupRegistryInstance;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> BackupRegistry <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (backupRegistryInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String backupRegistryClassName = config.getBackupRegistryImpl();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != backupRegistryClassName) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            backupRegistryInstance = (BackupRegistry) Class.forName(backupRegistryClassName).newInstance();</span><br><span class="line">                            logger.info(<span class="string">"Enabled backup registry of type &#123;&#125;"</span>, backupRegistryInstance.getClass());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">                            logger.error(<span class="string">"Error instantiating BackupRegistry."</span>, e);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                            logger.error(<span class="string">"Error instantiating BackupRegistry."</span>, e);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                            logger.error(<span class="string">"Error instantiating BackupRegistry."</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (backupRegistryInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        logger.warn(<span class="string">"Using default backup registry implementation which does not do anything."</span>);</span><br><span class="line">                        backupRegistryInstance = <span class="keyword">new</span> NotImplementedRegistryImpl();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> backupRegistryInstance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, randomizer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> Use &#123;<span class="doctag">@link</span> #DiscoveryClient(ApplicationInfoManager, EurekaClientConfig, AbstractDiscoveryClientOptionalArgs, Provider&lt;BackupRegistry&gt;, EndpointRandomizer)&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</span><br><span class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</span><br><span class="line">        <span class="keyword">this</span>(applicationInfoManager, config, args, backupRegistryProvider, ResolverUtils::randomize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</span><br><span class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider, EndpointRandomizer endpointRandomizer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckHandlerProvider = args.healthCheckHandlerProvider;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckCallbackProvider = args.healthCheckCallbackProvider;</span><br><span class="line">            <span class="keyword">this</span>.eventListeners.addAll(args.getEventListeners());</span><br><span class="line">            <span class="keyword">this</span>.preRegistrationHandler = args.preRegistrationHandler;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckCallbackProvider = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckHandlerProvider = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.preRegistrationHandler = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</span><br><span class="line">        InstanceInfo myInfo = applicationInfoManager.getInfo();</span><br><span class="line"></span><br><span class="line">        clientConfig = config;</span><br><span class="line">        staticClientConfig = clientConfig;</span><br><span class="line">        transportConfig = config.getTransportConfig();</span><br><span class="line">        instanceInfo = myInfo;</span><br><span class="line">        <span class="keyword">if</span> (myInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            appPathIdentifier = instanceInfo.getAppName() + <span class="string">"/"</span> + instanceInfo.getId();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Setting instanceInfo to a passed in null value"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.backupRegistryProvider = backupRegistryProvider;</span><br><span class="line">        <span class="keyword">this</span>.endpointRandomizer = endpointRandomizer;</span><br><span class="line">        <span class="keyword">this</span>.urlRandomizer = <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(instanceInfo);</span><br><span class="line">        localRegionApps.set(<span class="keyword">new</span> Applications());</span><br><span class="line"></span><br><span class="line">        fetchRegistryGeneration = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        remoteRegionsToFetch = <span class="keyword">new</span> AtomicReference&lt;String&gt;(clientConfig.fetchRegistryForRemoteRegions());</span><br><span class="line">        remoteRegionsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(remoteRegionsToFetch.get() == <span class="keyword">null</span> ? <span class="keyword">null</span> : remoteRegionsToFetch.get().split(<span class="string">","</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.shouldFetchRegistry()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.registryStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRY_PREFIX + <span class="string">"lastUpdateSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.registryStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.heartbeatStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRATION_PREFIX + <span class="string">"lastHeartbeatSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.heartbeatStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"Initializing Eureka in region &#123;&#125;"</span>, clientConfig.getRegion());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!config.shouldRegisterWithEureka() &amp;&amp; !config.shouldFetchRegistry()) &#123;</span><br><span class="line">            logger.info(<span class="string">"Client configured to neither register nor query for data."</span>);</span><br><span class="line">            scheduler = <span class="keyword">null</span>;</span><br><span class="line">            heartbeatExecutor = <span class="keyword">null</span>;</span><br><span class="line">            cacheRefreshExecutor = <span class="keyword">null</span>;</span><br><span class="line">            eurekaTransport = <span class="keyword">null</span>;</span><br><span class="line">            instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(<span class="keyword">new</span> PropertyBasedAzToRegionMapper(config), clientConfig.getRegion());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></span><br><span class="line">            <span class="comment">// to work with DI'd DiscoveryClient</span></span><br><span class="line">            DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</span><br><span class="line">            DiscoveryManager.getInstance().setEurekaClientConfig(config);</span><br><span class="line"></span><br><span class="line">            initTimestampMs = System.currentTimeMillis();</span><br><span class="line">            logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</span><br><span class="line">                    initTimestampMs, <span class="keyword">this</span>.getApplications().size());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// no need to setup up an network tasks and we are done</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></span><br><span class="line">            scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</span><br><span class="line">                    <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">                            .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</span><br><span class="line">                            .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                    <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">                    <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                    <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">                            .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</span><br><span class="line">                            .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">                            .build()</span><br><span class="line">            );  <span class="comment">// use direct handoff</span></span><br><span class="line"></span><br><span class="line">            cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                    <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">                    <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                    <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">                            .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</span><br><span class="line">                            .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">                            .build()</span><br><span class="line">            );  <span class="comment">// use direct handoff</span></span><br><span class="line"></span><br><span class="line">            eurekaTransport = <span class="keyword">new</span> EurekaTransport();</span><br><span class="line">            scheduleServerEndpointTask(eurekaTransport, args);</span><br><span class="line"></span><br><span class="line">            AzToRegionMapper azToRegionMapper;</span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</span><br><span class="line">                azToRegionMapper = <span class="keyword">new</span> DNSBasedAzToRegionMapper(clientConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                azToRegionMapper = <span class="keyword">new</span> PropertyBasedAzToRegionMapper(clientConfig);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsToFetch.get()) &#123;</span><br><span class="line">                azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(<span class="string">","</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to initialize DiscoveryClient!"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</span><br><span class="line">            fetchRegistryFromBackup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// call and execute the pre registration handler before all background tasks (inc registration) is started</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.preRegistrationHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.preRegistrationHandler.beforeRegistration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka() &amp;&amp; clientConfig.shouldEnforceRegistrationAtInit()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!register() ) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Registration error at startup. Invalid server response."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">                logger.error(<span class="string">"Registration error at startup: &#123;&#125;"</span>, th.getMessage());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(th);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// finally, init the schedule tasks (e.g. cluster resolvers, heartbeat, instanceInfo replicator, fetch</span></span><br><span class="line">        initScheduledTasks();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Monitors.registerObject(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Cannot register timers"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></span><br><span class="line">        <span class="comment">// to work with DI'd DiscoveryClient</span></span><br><span class="line">        DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</span><br><span class="line">        DiscoveryManager.getInstance().setEurekaClientConfig(config);</span><br><span class="line"></span><br><span class="line">        initTimestampMs = System.currentTimeMillis();</span><br><span class="line">        logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</span><br><span class="line">                initTimestampMs, <span class="keyword">this</span>.getApplications().size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleServerEndpointTask</span><span class="params">(EurekaTransport eurekaTransport,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        Collection&lt;?&gt; additionalFilters = args == <span class="keyword">null</span></span><br><span class="line">                ? Collections.emptyList()</span><br><span class="line">                : args.additionalFilters;</span><br><span class="line"></span><br><span class="line">        EurekaJerseyClient providedJerseyClient = args == <span class="keyword">null</span></span><br><span class="line">                ? <span class="keyword">null</span></span><br><span class="line">                : args.eurekaJerseyClient;</span><br><span class="line">        </span><br><span class="line">        TransportClientFactories argsTransportClientFactories = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.getTransportClientFactories() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsTransportClientFactories = args.getTransportClientFactories();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Ignore the raw types warnings since the client filter interface changed between jersey 1/2</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">        TransportClientFactories transportClientFactories = argsTransportClientFactories == <span class="keyword">null</span></span><br><span class="line">                ? <span class="keyword">new</span> Jersey1TransportClientFactories()</span><br><span class="line">                : argsTransportClientFactories;</span><br><span class="line">                </span><br><span class="line">        Optional&lt;SSLContext&gt; sslContext = args == <span class="keyword">null</span></span><br><span class="line">                ? Optional.empty()</span><br><span class="line">                : args.getSSLContext();</span><br><span class="line">        Optional&lt;HostnameVerifier&gt; hostnameVerifier = args == <span class="keyword">null</span></span><br><span class="line">                ? Optional.empty()</span><br><span class="line">                : args.getHostnameVerifier();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the transport factory was not supplied with args, assume they are using jersey 1 for passivity</span></span><br><span class="line">        eurekaTransport.transportClientFactory = providedJerseyClient == <span class="keyword">null</span></span><br><span class="line">                ? transportClientFactories.newTransportClientFactory(clientConfig, additionalFilters, applicationInfoManager.getInfo(), sslContext, hostnameVerifier)</span><br><span class="line">                : transportClientFactories.newTransportClientFactory(additionalFilters, providedJerseyClient);</span><br><span class="line"></span><br><span class="line">        ApplicationsResolver.ApplicationsSource applicationsSource = <span class="keyword">new</span> ApplicationsResolver.ApplicationsSource() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">(<span class="keyword">int</span> stalenessThreshold, TimeUnit timeUnit)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> thresholdInMs = TimeUnit.MILLISECONDS.convert(stalenessThreshold, timeUnit);</span><br><span class="line">                <span class="keyword">long</span> delay = getLastSuccessfulRegistryFetchTimePeriod();</span><br><span class="line">                <span class="keyword">if</span> (delay &gt; thresholdInMs) &#123;</span><br><span class="line">                    logger.info(<span class="string">"Local registry is too stale for local lookup. Threshold:&#123;&#125;, actual:&#123;&#125;"</span>,</span><br><span class="line">                            thresholdInMs, delay);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> localRegionApps.get();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(</span><br><span class="line">                clientConfig,</span><br><span class="line">                transportConfig,</span><br><span class="line">                eurekaTransport.transportClientFactory,</span><br><span class="line">                applicationInfoManager.getInfo(),</span><br><span class="line">                applicationsSource,</span><br><span class="line">                endpointRandomizer</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            EurekaHttpClientFactory newRegistrationClientFactory = <span class="keyword">null</span>;</span><br><span class="line">            EurekaHttpClient newRegistrationClient = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                newRegistrationClientFactory = EurekaHttpClients.registrationClientFactory(</span><br><span class="line">                        eurekaTransport.bootstrapResolver,</span><br><span class="line">                        eurekaTransport.transportClientFactory,</span><br><span class="line">                        transportConfig</span><br><span class="line">                );</span><br><span class="line">                newRegistrationClient = newRegistrationClientFactory.newClient();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Transport initialization failure"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            eurekaTransport.registrationClientFactory = newRegistrationClientFactory;</span><br><span class="line">            eurekaTransport.registrationClient = newRegistrationClient;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// new method (resolve from primary servers for read)</span></span><br><span class="line">        <span class="comment">// Configure new transport layer (candidate for injecting in the future)</span></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            EurekaHttpClientFactory newQueryClientFactory = <span class="keyword">null</span>;</span><br><span class="line">            EurekaHttpClient newQueryClient = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                newQueryClientFactory = EurekaHttpClients.queryClientFactory(</span><br><span class="line">                        eurekaTransport.bootstrapResolver,</span><br><span class="line">                        eurekaTransport.transportClientFactory,</span><br><span class="line">                        clientConfig,</span><br><span class="line">                        transportConfig,</span><br><span class="line">                        applicationInfoManager.getInfo(),</span><br><span class="line">                        applicationsSource,</span><br><span class="line">                        endpointRandomizer</span><br><span class="line">                );</span><br><span class="line">                newQueryClient = newQueryClientFactory.newClient();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"Transport initialization failure"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            eurekaTransport.queryClientFactory = newQueryClientFactory;</span><br><span class="line">            eurekaTransport.queryClient = newQueryClient;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaClientConfig <span class="title">getEurekaClientConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationInfoManager <span class="title">getApplicationInfoManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationInfoManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * (non-Javadoc)</span></span><br><span class="line"><span class="comment">     * @see com.netflix.discovery.shared.LookupService#getApplication(java.lang.String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">getApplication</span><span class="params">(String appName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getApplications().getRegisteredApplications(appName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * (non-Javadoc)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @see com.netflix.discovery.shared.LookupService#getApplications()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> localRegionApps.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsForARegion</span><span class="params">(@Nullable String region)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instanceRegionChecker.isLocalRegion(region)) &#123;</span><br><span class="line">            <span class="keyword">return</span> localRegionApps.get();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> remoteRegionVsApps.get(region);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAllKnownRegions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String localRegion = instanceRegionChecker.getLocalRegion();</span><br><span class="line">        <span class="keyword">if</span> (!remoteRegionVsApps.isEmpty()) &#123;</span><br><span class="line">            Set&lt;String&gt; regions = remoteRegionVsApps.keySet();</span><br><span class="line">            Set&lt;String&gt; toReturn = <span class="keyword">new</span> HashSet&lt;String&gt;(regions);</span><br><span class="line">            toReturn.add(localRegion);</span><br><span class="line">            <span class="keyword">return</span> toReturn;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(localRegion);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * (non-Javadoc)</span></span><br><span class="line"><span class="comment">     * @see com.netflix.discovery.shared.LookupService#getInstancesById(java.lang.String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        List&lt;InstanceInfo&gt; instancesList = <span class="keyword">new</span> ArrayList&lt;InstanceInfo&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Application app : <span class="keyword">this</span>.getApplications()</span><br><span class="line">                .getRegisteredApplications()) &#123;</span><br><span class="line">            InstanceInfo instanceInfo = app.getByInstanceId(id);</span><br><span class="line">            <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                instancesList.add(instanceInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instancesList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register &#123;<span class="doctag">@link</span> HealthCheckCallback&#125; with the eureka client.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Once registered, the eureka client will invoke the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> HealthCheckCallback&#125; in intervals specified by</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EurekaClientConfig#getInstanceInfoReplicationIntervalSeconds()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callback app specific healthcheck.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> Use</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerHealthCheckCallback</span><span class="params">(HealthCheckCallback callback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instanceInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot register a listener for instance info since it is null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            healthCheckHandlerRef.set(<span class="keyword">new</span> HealthCheckCallbackToHandlerBridge(callback));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerHealthCheck</span><span class="params">(HealthCheckHandler healthCheckHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instanceInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot register a healthcheck handler when instance info is null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (healthCheckHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckHandlerRef.set(healthCheckHandler);</span><br><span class="line">            <span class="comment">// schedule an onDemand update of the instanceInfo when a new healthcheck handler is registered</span></span><br><span class="line">            <span class="keyword">if</span> (instanceInfoReplicator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerEventListener</span><span class="params">(EurekaEventListener eventListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventListeners.add(eventListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">unregisterEventListener</span><span class="params">(EurekaEventListener eventListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.eventListeners.remove(eventListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the list of instances matching the given VIP Address.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vipAddress</span></span><br><span class="line"><span class="comment">     *            - The VIP address to match the instances for.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secure</span></span><br><span class="line"><span class="comment">     *            - true if it is a secure vip address, false otherwise</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The list of &#123;<span class="doctag">@link</span> InstanceInfo&#125; objects matching the criteria</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesByVipAddress</span><span class="params">(String vipAddress, <span class="keyword">boolean</span> secure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getInstancesByVipAddress(vipAddress, secure, instanceRegionChecker.getLocalRegion());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the list of instances matching the given VIP Address in the passed region.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vipAddress - The VIP address to match the instances for.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secure - true if it is a secure vip address, false otherwise</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> region - region from which the instances are to be fetched. If &lt;code&gt;null&lt;/code&gt; then local region is</span></span><br><span class="line"><span class="comment">     *               assumed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The list of &#123;<span class="doctag">@link</span> InstanceInfo&#125; objects matching the criteria, empty list if not instances found.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesByVipAddress</span><span class="params">(String vipAddress, <span class="keyword">boolean</span> secure,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                       @Nullable String region)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (vipAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Supplied VIP Address cannot be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Applications applications;</span><br><span class="line">        <span class="keyword">if</span> (instanceRegionChecker.isLocalRegion(region)) &#123;</span><br><span class="line">            applications = <span class="keyword">this</span>.localRegionApps.get();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            applications = remoteRegionVsApps.get(region);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == applications) &#123;</span><br><span class="line">                logger.debug(<span class="string">"No applications are defined for region &#123;&#125;, so returning an empty instance list for vip "</span></span><br><span class="line">                        + <span class="string">"address &#123;&#125;."</span>, region, vipAddress);</span><br><span class="line">                <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!secure) &#123;</span><br><span class="line">            <span class="keyword">return</span> applications.getInstancesByVirtualHostName(vipAddress);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> applications.getInstancesBySecureVirtualHostName(vipAddress);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the list of instances matching the given VIP Address and the given</span></span><br><span class="line"><span class="comment">     * application name if both of them are not null. If one of them is null,</span></span><br><span class="line"><span class="comment">     * then that criterion is completely ignored for matching instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vipAddress</span></span><br><span class="line"><span class="comment">     *            - The VIP address to match the instances for.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> appName</span></span><br><span class="line"><span class="comment">     *            - The applicationName to match the instances for.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secure</span></span><br><span class="line"><span class="comment">     *            - true if it is a secure vip address, false otherwise.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The list of &#123;<span class="doctag">@link</span> InstanceInfo&#125; objects matching the criteria.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesByVipAddressAndAppName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String vipAddress, String appName, <span class="keyword">boolean</span> secure)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;InstanceInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;InstanceInfo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (vipAddress == <span class="keyword">null</span> &amp;&amp; appName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Supplied VIP Address and application name cannot both be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vipAddress != <span class="keyword">null</span> &amp;&amp; appName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getInstancesByVipAddress(vipAddress, secure);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vipAddress == <span class="keyword">null</span> &amp;&amp; appName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Application application = getApplication(appName);</span><br><span class="line">            <span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result = application.getInstances();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String instanceVipAddress;</span><br><span class="line">        <span class="keyword">for</span> (Application app : getApplications().getRegisteredApplications()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">                    instanceVipAddress = instance.getSecureVipAddress();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    instanceVipAddress = instance.getVIPAddress();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (instanceVipAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] instanceVipAddresses = instanceVipAddress</span><br><span class="line">                        .split(COMMA_STRING);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If the VIP Address is delimited by a comma, then consider to</span></span><br><span class="line">                <span class="comment">// be a list of VIP Addresses.</span></span><br><span class="line">                <span class="comment">// Try to match at least one in the list, if it matches then</span></span><br><span class="line">                <span class="comment">// return the instance info for the same</span></span><br><span class="line">                <span class="keyword">for</span> (String vipAddressFromList : instanceVipAddresses) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (vipAddress.equalsIgnoreCase(vipAddressFromList.trim())</span><br><span class="line">                            &amp;&amp; appName.equalsIgnoreCase(instance.getAppName())) &#123;</span><br><span class="line">                        result.add(instance);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * (non-Javadoc)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @see</span></span><br><span class="line"><span class="comment">     * com.netflix.discovery.shared.LookupService#getNextServerFromEureka(java</span></span><br><span class="line"><span class="comment">     * .lang.String, boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InstanceInfo <span class="title">getNextServerFromEureka</span><span class="params">(String virtualHostname, <span class="keyword">boolean</span> secure)</span> </span>&#123;</span><br><span class="line">        List&lt;InstanceInfo&gt; instanceInfoList = <span class="keyword">this</span>.getInstancesByVipAddress(</span><br><span class="line">                virtualHostname, secure);</span><br><span class="line">        <span class="keyword">if</span> (instanceInfoList == <span class="keyword">null</span> || instanceInfoList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No matches for the virtual host name :"</span></span><br><span class="line">                    + virtualHostname);</span><br><span class="line">        &#125;</span><br><span class="line">        Applications apps = <span class="keyword">this</span>.localRegionApps.get();</span><br><span class="line">        <span class="keyword">int</span> index = (<span class="keyword">int</span>) (apps.getNextIndex(virtualHostname,</span><br><span class="line">                secure).incrementAndGet() % instanceInfoList.size());</span><br><span class="line">        <span class="keyword">return</span> instanceInfoList.get(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get all applications registered with a specific eureka service.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceUrl</span></span><br><span class="line"><span class="comment">     *            - The string representation of the service url.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The registry information containing all applications.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">(String serviceUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EurekaHttpResponse&lt;Applications&gt; response = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></span><br><span class="line">                    ? eurekaTransport.queryClient.getApplications()</span><br><span class="line">                    : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode() == Status.OK.getStatusCode()) &#123;</span><br><span class="line">                logger.debug(PREFIX + <span class="string">"&#123;&#125; -  refresh status: &#123;&#125;"</span>, appPathIdentifier, response.getStatusCode());</span><br><span class="line">                <span class="keyword">return</span> response.getEntity();</span><br><span class="line">            &#125;</span><br><span class="line">            logger.error(PREFIX + <span class="string">"&#123;&#125; - was unable to refresh its cache! status = &#123;&#125;"</span>, appPathIdentifier, response.getStatusCode());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            logger.error(PREFIX + <span class="string">"&#123;&#125; - was unable to refresh its cache! status = &#123;&#125;"</span>, appPathIdentifier, th.getMessage(), th);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register with the eureka service by making the appropriate REST call.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.info(PREFIX + <span class="string">"&#123;&#125;: registering service..."</span>, appPathIdentifier);</span><br><span class="line">        EurekaHttpResponse&lt;Void&gt; httpResponse;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(PREFIX + <span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, appPathIdentifier, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(PREFIX + <span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> httpResponse.getStatusCode() == Status.NO_CONTENT.getStatusCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Renew with the eureka service by making the appropriate REST call</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</span><br><span class="line">            logger.debug(PREFIX + <span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">            <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.NOT_FOUND.getStatusCode()) &#123;</span><br><span class="line">                REREGISTER_COUNTER.increment();</span><br><span class="line">                logger.info(PREFIX + <span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, appPathIdentifier, instanceInfo.getAppName());</span><br><span class="line">                <span class="keyword">long</span> timestamp = instanceInfo.setIsDirtyWithTime();</span><br><span class="line">                <span class="keyword">boolean</span> success = register();</span><br><span class="line">                <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                    instanceInfo.unsetIsDirty(timestamp);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> success;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> httpResponse.getStatusCode() == Status.OK.getStatusCode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(PREFIX + <span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, appPathIdentifier, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see replacement in &#123;<span class="doctag">@link</span> com.netflix.discovery.endpoint.EndpointUtils&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Get the list of all eureka service urls from properties file for the eureka client to talk to.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instanceZone The zone in which the client resides</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preferSameZone true if we have to prefer the same zone as the client, false otherwise</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The list of all eureka service urls for the eureka client to talk to</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServiceUrlsFromConfig</span><span class="params">(String instanceZone, <span class="keyword">boolean</span> preferSameZone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EndpointUtils.getServiceUrlsFromConfig(clientConfig, instanceZone, preferSameZone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shuts down Eureka Client. Also sends a deregistration request to the</span></span><br><span class="line"><span class="comment">     * eureka server.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isShutdown.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            logger.info(<span class="string">"Shutting down DiscoveryClient ..."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (statusChangeListener != <span class="keyword">null</span> &amp;&amp; applicationInfoManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cancelScheduledTasks();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If APPINFO was registered</span></span><br><span class="line">            <span class="keyword">if</span> (applicationInfoManager != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; clientConfig.shouldRegisterWithEureka()</span><br><span class="line">                    &amp;&amp; clientConfig.shouldUnregisterOnShutdown()) &#123;</span><br><span class="line">                applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</span><br><span class="line">                unregister();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (eurekaTransport != <span class="keyword">null</span>) &#123;</span><br><span class="line">                eurekaTransport.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            heartbeatStalenessMonitor.shutdown();</span><br><span class="line">            registryStalenessMonitor.shutdown();</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"Completed shut down of DiscoveryClient"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * unregister w/ the eureka service.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// It can be null if shouldRegisterWithEureka == false</span></span><br><span class="line">        <span class="keyword">if</span>(eurekaTransport != <span class="keyword">null</span> &amp;&amp; eurekaTransport.registrationClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                logger.info(<span class="string">"Unregistering ..."</span>);</span><br><span class="line">                EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());</span><br><span class="line">                logger.info(PREFIX + <span class="string">"&#123;&#125; - deregister  status: &#123;&#125;"</span>, appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(PREFIX + <span class="string">"&#123;&#125; - de-registration failed&#123;&#125;"</span>, appPathIdentifier, e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fetches the registry information.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method tries to get only deltas after the first fetch unless there</span></span><br><span class="line"><span class="comment">     * is an issue in reconciling eureka server and client registry information.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> forceFullRegistryFetch Forces a full registry fetch.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the registry was fetched</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// If the delta is disabled or if it is the first time, get all</span></span><br><span class="line">            <span class="comment">// applications</span></span><br><span class="line">            Applications applications = getApplications();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldDisableDelta()</span><br><span class="line">                    || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">                    || forceFullRegistryFetch</span><br><span class="line">                    || (applications == <span class="keyword">null</span>)</span><br><span class="line">                    || (applications.getRegisteredApplications().size() == <span class="number">0</span>)</span><br><span class="line">                    || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></span><br><span class="line">            &#123;</span><br><span class="line">                logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, clientConfig.shouldDisableDelta());</span><br><span class="line">                logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">                logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, forceFullRegistryFetch);</span><br><span class="line">                logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, (applications == <span class="keyword">null</span>));</span><br><span class="line">                logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>,</span><br><span class="line">                        (applications.getRegisteredApplications().size() == <span class="number">0</span>));</span><br><span class="line">                logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, (applications.getVersion() == -<span class="number">1</span>));</span><br><span class="line">                getAndStoreFullRegistry();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                getAndUpdateDelta(applications);</span><br><span class="line">            &#125;</span><br><span class="line">            applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">            logTotalInstances();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(PREFIX + <span class="string">"&#123;&#125; - was unable to refresh its cache! status = &#123;&#125;"</span>, appPathIdentifier, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                tracer.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify about cache refresh before updating the instance remote status</span></span><br><span class="line">        onCacheRefreshed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update remote status based on refreshed data held in the cache</span></span><br><span class="line">        updateInstanceRemoteStatus();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// registry was fetched successfully, so return true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateInstanceRemoteStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Determine this instance's status for this app and set to UNKNOWN if not found</span></span><br><span class="line">        InstanceInfo.InstanceStatus currentRemoteInstanceStatus = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (instanceInfo.getAppName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Application app = getApplication(instanceInfo.getAppName());</span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                InstanceInfo remoteInstanceInfo = app.getByInstanceId(instanceInfo.getId());</span><br><span class="line">                <span class="keyword">if</span> (remoteInstanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    currentRemoteInstanceStatus = remoteInstanceInfo.getStatus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentRemoteInstanceStatus == <span class="keyword">null</span>) &#123;</span><br><span class="line">            currentRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify if status changed</span></span><br><span class="line">        <span class="keyword">if</span> (lastRemoteInstanceStatus != currentRemoteInstanceStatus) &#123;</span><br><span class="line">            onRemoteStatusChanged(lastRemoteInstanceStatus, currentRemoteInstanceStatus);</span><br><span class="line">            lastRemoteInstanceStatus = currentRemoteInstanceStatus;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Return he current instance status as seen on the Eureka server.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">getInstanceRemoteStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastRemoteInstanceStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getReconcileHashCode</span><span class="params">(Applications applications)</span> </span>&#123;</span><br><span class="line">        TreeMap&lt;String, AtomicInteger&gt; instanceCountMap = <span class="keyword">new</span> TreeMap&lt;String, AtomicInteger&gt;();</span><br><span class="line">        <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Applications remoteApp : remoteRegionVsApps.values()) &#123;</span><br><span class="line">                remoteApp.populateInstanceCountMap(instanceCountMap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        applications.populateInstanceCountMap(instanceCountMap);</span><br><span class="line">        <span class="keyword">return</span> Applications.getReconcileHashCode(instanceCountMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the full registry information from the eureka server and stores it locally.</span></span><br><span class="line"><span class="comment">     * When applying the full registry, the following flow is observed:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * if (update generation have not advanced (due to another thread))</span></span><br><span class="line"><span class="comment">     *   atomically set the registry to the new registry</span></span><br><span class="line"><span class="comment">     * fi</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the full registry information.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     *             on error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndStoreFullRegistry</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"Getting all instance registry info from the eureka server"</span>);</span><br><span class="line"></span><br><span class="line">        Applications apps = <span class="keyword">null</span>;</span><br><span class="line">        EurekaHttpResponse&lt;Applications&gt; httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></span><br><span class="line">                ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())</span><br><span class="line">                : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</span><br><span class="line">        <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</span><br><span class="line">            apps = httpResponse.getEntity();</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"The response status is &#123;&#125;"</span>, httpResponse.getStatusCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"The application is null for some reason. Not storing this information"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</span><br><span class="line">            localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(apps));</span><br><span class="line">            logger.debug(<span class="string">"Got full registry with apps hashcode &#123;&#125;"</span>, apps.getAppsHashCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Not updating applications as another thread is updating it already"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the delta registry information from the eureka server and update it locally.</span></span><br><span class="line"><span class="comment">     * When applying the delta, the following flow is observed:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * if (update generation have not advanced (due to another thread))</span></span><br><span class="line"><span class="comment">     *   atomically try to: update application with the delta and get reconcileHashCode</span></span><br><span class="line"><span class="comment">     *   abort entire processing otherwise</span></span><br><span class="line"><span class="comment">     *   do reconciliation if reconcileHashCode clash</span></span><br><span class="line"><span class="comment">     * fi</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the client response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable on error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndUpdateDelta</span><span class="params">(Applications applications)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</span><br><span class="line"></span><br><span class="line">        Applications delta = <span class="keyword">null</span>;</span><br><span class="line">        EurekaHttpResponse&lt;Applications&gt; httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());</span><br><span class="line">        <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</span><br><span class="line">            delta = httpResponse.getEntity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (delta == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">"The server does not allow the delta revision to be applied because it is not safe. "</span></span><br><span class="line">                    + <span class="string">"Hence got the full registry."</span>);</span><br><span class="line">            getAndStoreFullRegistry();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Got delta update with apps hashcode &#123;&#125;"</span>, delta.getAppsHashCode());</span><br><span class="line">            String reconcileHashCode = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span> (fetchRegistryUpdateLock.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    updateDelta(delta);</span><br><span class="line">                    reconcileHashCode = getReconcileHashCode(applications);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    fetchRegistryUpdateLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">"Cannot acquire update lock, aborting getAndUpdateDelta"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// There is a diff in number of instances for some reason</span></span><br><span class="line">            <span class="keyword">if</span> (!reconcileHashCode.equals(delta.getAppsHashCode()) || clientConfig.shouldLogDeltaDiff()) &#123;</span><br><span class="line">                reconcileAndLogDifference(delta, reconcileHashCode);  <span class="comment">// this makes a remoteCall</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Not updating application delta as another thread is updating it already"</span>);</span><br><span class="line">            logger.debug(<span class="string">"Ignoring delta update with apps hashcode &#123;&#125;, as another thread is updating it already"</span>, delta.getAppsHashCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Logs the total number of non-filtered instances stored locally.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logTotalInstances</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">int</span> totInstances = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Application application : getApplications().getRegisteredApplications()) &#123;</span><br><span class="line">                totInstances += application.getInstancesAsIsFromEureka().size();</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(<span class="string">"The total number of all instances in the client now is &#123;&#125;"</span>, totInstances);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reconcile the eureka server and client registry information and logs the differences if any.</span></span><br><span class="line"><span class="comment">     * When reconciling, the following flow is observed:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * make a remote call to the server for the full registry</span></span><br><span class="line"><span class="comment">     * calculate and log differences</span></span><br><span class="line"><span class="comment">     * if (update generation have not advanced (due to another thread))</span></span><br><span class="line"><span class="comment">     *   atomically set the registry to the new registry</span></span><br><span class="line"><span class="comment">     * fi</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta</span></span><br><span class="line"><span class="comment">     *            the last delta registry information received from the eureka</span></span><br><span class="line"><span class="comment">     *            server.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reconcileHashCode</span></span><br><span class="line"><span class="comment">     *            the hashcode generated by the server for reconciliation.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ClientResponse the HTTP response object.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     *             on any error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconcileAndLogDifference</span><span class="params">(Applications delta, String reconcileHashCode)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"The Reconcile hashcodes do not match, client : &#123;&#125;, server : &#123;&#125;. Getting the full registry"</span>,</span><br><span class="line">                reconcileHashCode, delta.getAppsHashCode());</span><br><span class="line"></span><br><span class="line">        RECONCILE_HASH_CODES_MISMATCH.increment();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</span><br><span class="line"></span><br><span class="line">        EurekaHttpResponse&lt;Applications&gt; httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></span><br><span class="line">                ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())</span><br><span class="line">                : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</span><br><span class="line">        Applications serverApps = httpResponse.getEntity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (serverApps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Cannot fetch full registry from the server; reconciliation failure"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</span><br><span class="line">            localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(serverApps));</span><br><span class="line">            getApplications().setVersion(delta.getVersion());</span><br><span class="line">            logger.debug(</span><br><span class="line">                    <span class="string">"The Reconcile hashcodes after complete sync up, client : &#123;&#125;, server : &#123;&#125;."</span>,</span><br><span class="line">                    getApplications().getReconcileHashCode(),</span><br><span class="line">                    delta.getAppsHashCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Not setting the applications map as another thread has advanced the update generation"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Updates the delta information fetches from the eureka server into the</span></span><br><span class="line"><span class="comment">     * local cache.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta</span></span><br><span class="line"><span class="comment">     *            the delta information received from eureka server in the last</span></span><br><span class="line"><span class="comment">     *            poll cycle.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDelta</span><span class="params">(Applications delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> deltaCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Application app : delta.getRegisteredApplications()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</span><br><span class="line">                Applications applications = getApplications();</span><br><span class="line">                String instanceRegion = instanceRegionChecker.getInstanceRegion(instance);</span><br><span class="line">                <span class="keyword">if</span> (!instanceRegionChecker.isLocalRegion(instanceRegion)) &#123;</span><br><span class="line">                    Applications remoteApps = remoteRegionVsApps.get(instanceRegion);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == remoteApps) &#123;</span><br><span class="line">                        remoteApps = <span class="keyword">new</span> Applications();</span><br><span class="line">                        remoteRegionVsApps.put(instanceRegion, remoteApps);</span><br><span class="line">                    &#125;</span><br><span class="line">                    applications = remoteApps;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++deltaCount;</span><br><span class="line">                <span class="keyword">if</span> (ActionType.ADDED.equals(instance.getActionType())) &#123;</span><br><span class="line">                    Application existingApp = applications.getRegisteredApplications(instance.getAppName());</span><br><span class="line">                    <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        applications.addApplication(app);</span><br><span class="line">                    &#125;</span><br><span class="line">                    logger.debug(<span class="string">"Added instance &#123;&#125; to the existing apps in region &#123;&#125;"</span>, instance.getId(), instanceRegion);</span><br><span class="line">                    applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.MODIFIED.equals(instance.getActionType())) &#123;</span><br><span class="line">                    Application existingApp = applications.getRegisteredApplications(instance.getAppName());</span><br><span class="line">                    <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        applications.addApplication(app);</span><br><span class="line">                    &#125;</span><br><span class="line">                    logger.debug(<span class="string">"Modified instance &#123;&#125; to the existing apps "</span>, instance.getId());</span><br><span class="line"></span><br><span class="line">                    applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.DELETED.equals(instance.getActionType())) &#123;</span><br><span class="line">                    Application existingApp = applications.getRegisteredApplications(instance.getAppName());</span><br><span class="line">                    <span class="keyword">if</span> (existingApp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Deleted instance &#123;&#125; to the existing apps "</span>, instance.getId());</span><br><span class="line">                        existingApp.removeInstance(instance);</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * We find all instance list from application(The status of instance status is not only the status is UP but also other status)</span></span><br><span class="line"><span class="comment">                         * if instance list is empty, we remove the application.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">if</span> (existingApp.getInstancesAsIsFromEureka().isEmpty()) &#123;</span><br><span class="line">                            applications.removeApplication(existingApp);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.debug(<span class="string">"The total number of instances fetched by the delta processor : &#123;&#125;"</span>, deltaCount);</span><br><span class="line"></span><br><span class="line">        getApplications().setVersion(delta.getVersion());</span><br><span class="line">        getApplications().shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Applications applications : remoteRegionVsApps.values()) &#123;</span><br><span class="line">            applications.setVersion(delta.getVersion());</span><br><span class="line">            applications.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes all scheduled tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            <span class="comment">// registry cache refresh timer</span></span><br><span class="line">            <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"cacheRefresh"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            cacheRefreshExecutor,</span><br><span class="line">                            registryFetchIntervalSeconds,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">                    ),</span><br><span class="line">                    registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: &#123;&#125;"</span>, renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Heartbeat timer</span></span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"heartbeat"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            heartbeatExecutor,</span><br><span class="line">                            renewalIntervalInSecs,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">                    ),</span><br><span class="line">                    renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    instanceInfo,</span><br><span class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line"></span><br><span class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">                        logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instanceInfoReplicator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instanceInfoReplicator.stop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (heartbeatExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            heartbeatExecutor.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cacheRefreshExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cacheRefreshExecutor.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scheduler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            scheduler.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see replacement in &#123;<span class="doctag">@link</span> com.netflix.discovery.endpoint.EndpointUtils&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Get the list of all eureka service urls from DNS for the eureka client to</span></span><br><span class="line"><span class="comment">     * talk to. The client picks up the service url from its zone and then fails over to</span></span><br><span class="line"><span class="comment">     * other zones randomly. If there are multiple servers in the same zone, the client once</span></span><br><span class="line"><span class="comment">     * again picks one randomly. This way the traffic will be distributed in the case of failures.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instanceZone The zone in which the client resides.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preferSameZone true if we have to prefer the same zone as the client, false otherwise.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The list of all eureka service urls for the eureka client to talk to.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServiceUrlsFromDNS</span><span class="params">(String instanceZone, <span class="keyword">boolean</span> preferSameZone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EndpointUtils.getServiceUrlsFromDNS(clientConfig, instanceZone, preferSameZone, urlRandomizer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see replacement in &#123;<span class="doctag">@link</span> com.netflix.discovery.endpoint.EndpointUtils&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getDiscoveryServiceUrls</span><span class="params">(String zone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EndpointUtils.getDiscoveryServiceUrls(clientConfig, zone, urlRandomizer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see replacement in &#123;<span class="doctag">@link</span> com.netflix.discovery.endpoint.EndpointUtils&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Get the list of EC2 URLs given the zone name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dnsName The dns name of the zone-specific CNAME</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type CNAME or EIP that needs to be retrieved</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The list of EC2 URLs associated with the dns name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getEC2DiscoveryUrlsFromZone</span><span class="params">(String dnsName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          EndpointUtils.DiscoveryUrlType type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EndpointUtils.getEC2DiscoveryUrlsFromZone(dnsName, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Refresh the current local instanceInfo. Note that after a valid refresh where changes are observed, the</span></span><br><span class="line"><span class="comment">     * isDirty flag on the instanceInfo is set to true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        applicationInfoManager.refreshDataCenterInfoIfRequired();</span><br><span class="line">        applicationInfoManager.refreshLeaseInfoIfRequired();</span><br><span class="line"></span><br><span class="line">        InstanceStatus status;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            status = getHealthCheckHandler().getStatus(instanceInfo.getStatus());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Exception from healthcheckHandler.getStatus, setting status to DOWN"</span>, e);</span><br><span class="line">            status = InstanceStatus.DOWN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != status) &#123;</span><br><span class="line">            applicationInfoManager.setInstanceStatus(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The heartbeat task that renews the lease in the given intervals.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (renew()) &#123;</span><br><span class="line">                lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">InstanceInfoReplicator <span class="title">getInstanceInfoReplicator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instanceInfoReplicator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">InstanceInfo <span class="title">getInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instanceInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HealthCheckHandler <span class="title">getHealthCheckHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HealthCheckHandler healthCheckHandler = <span class="keyword">this</span>.healthCheckHandlerRef.get();</span><br><span class="line">        <span class="keyword">if</span> (healthCheckHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != healthCheckHandlerProvider) &#123;</span><br><span class="line">                healthCheckHandler = healthCheckHandlerProvider.get();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != healthCheckCallbackProvider) &#123;</span><br><span class="line">                healthCheckHandler = <span class="keyword">new</span> HealthCheckCallbackToHandlerBridge(healthCheckCallbackProvider.get());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == healthCheckHandler) &#123;</span><br><span class="line">                healthCheckHandler = <span class="keyword">new</span> HealthCheckCallbackToHandlerBridge(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.healthCheckHandlerRef.compareAndSet(<span class="keyword">null</span>, healthCheckHandler);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.healthCheckHandlerRef.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The task that fetches the registry information at specified intervals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            refreshRegistry();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isFetchingRemoteRegionRegistries = isFetchingRemoteRegionRegistries();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> remoteRegionsModified = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// This makes sure that a dynamic change to remote regions to fetch is honored.</span></span><br><span class="line">            String latestRemoteRegions = clientConfig.fetchRegistryForRemoteRegions();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != latestRemoteRegions) &#123;</span><br><span class="line">                String currentRemoteRegions = remoteRegionsToFetch.get();</span><br><span class="line">                <span class="keyword">if</span> (!latestRemoteRegions.equals(currentRemoteRegions)) &#123;</span><br><span class="line">                    <span class="comment">// Both remoteRegionsToFetch and AzToRegionMapper.regionsToFetch need to be in sync</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (instanceRegionChecker.getAzToRegionMapper()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (remoteRegionsToFetch.compareAndSet(currentRemoteRegions, latestRemoteRegions)) &#123;</span><br><span class="line">                            String[] remoteRegions = latestRemoteRegions.split(<span class="string">","</span>);</span><br><span class="line">                            remoteRegionsRef.set(remoteRegions);</span><br><span class="line">                            instanceRegionChecker.getAzToRegionMapper().setRegionsToFetch(remoteRegions);</span><br><span class="line">                            remoteRegionsModified = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            logger.info(<span class="string">"Remote regions to fetch modified concurrently,"</span> +</span><br><span class="line">                                    <span class="string">" ignoring change from &#123;&#125; to &#123;&#125;"</span>, currentRemoteRegions, latestRemoteRegions);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Just refresh mapping to reflect any DNS/Property change</span></span><br><span class="line">                    instanceRegionChecker.getAzToRegionMapper().refreshMapping();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> success = fetchRegistry(remoteRegionsModified);</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                registrySize = localRegionApps.get().size();</span><br><span class="line">                lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                StringBuilder allAppsHashCodes = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                allAppsHashCodes.append(<span class="string">"Local region apps hashcode: "</span>);</span><br><span class="line">                allAppsHashCodes.append(localRegionApps.get().getAppsHashCode());</span><br><span class="line">                allAppsHashCodes.append(<span class="string">", is fetching remote regions? "</span>);</span><br><span class="line">                allAppsHashCodes.append(isFetchingRemoteRegionRegistries);</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Applications&gt; entry : remoteRegionVsApps.entrySet()) &#123;</span><br><span class="line">                    allAppsHashCodes.append(<span class="string">", Remote region: "</span>);</span><br><span class="line">                    allAppsHashCodes.append(entry.getKey());</span><br><span class="line">                    allAppsHashCodes.append(<span class="string">" , apps hashcode: "</span>);</span><br><span class="line">                    allAppsHashCodes.append(entry.getValue().getAppsHashCode());</span><br><span class="line">                &#125;</span><br><span class="line">                logger.debug(<span class="string">"Completed cache refresh task for discovery. All Apps hash code is &#123;&#125; "</span>,</span><br><span class="line">                        allAppsHashCodes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot fetch registry from server"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fetch the registry information from back up registry if all eureka server</span></span><br><span class="line"><span class="comment">     * urls are unreachable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchRegistryFromBackup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">            BackupRegistry backupRegistryInstance = newBackupRegistryInstance();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == backupRegistryInstance) &#123; <span class="comment">// backward compatibility with the old protected method, in case it is being used.</span></span><br><span class="line">                backupRegistryInstance = backupRegistryProvider.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != backupRegistryInstance) &#123;</span><br><span class="line">                Applications apps = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</span><br><span class="line">                    String remoteRegionsStr = remoteRegionsToFetch.get();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsStr) &#123;</span><br><span class="line">                        apps = backupRegistryInstance.fetchRegistry(remoteRegionsStr.split(<span class="string">","</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    apps = backupRegistryInstance.fetchRegistry();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Applications applications = <span class="keyword">this</span>.filterAndShuffle(apps);</span><br><span class="line">                    applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">                    localRegionApps.set(applications);</span><br><span class="line">                    logTotalInstances();</span><br><span class="line">                    logger.info(<span class="string">"Fetched registry successfully from the backup"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">"No backup registry instance defined &amp; unable to find any discovery servers."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Cannot fetch applications from apps although backup registry was specified"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> Use injection to provide &#123;<span class="doctag">@link</span> BackupRegistry&#125; implementation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BackupRegistry <span class="title">newBackupRegistryInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the &lt;em&gt;applications&lt;/em&gt; after filtering the applications for</span></span><br><span class="line"><span class="comment">     * instances with only UP states and shuffling them.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The filtering depends on the option specified by the configuration</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EurekaClientConfig#shouldFilterOnlyUpInstances()&#125;. Shuffling helps</span></span><br><span class="line"><span class="comment">     * in randomizing the applications list there by avoiding the same instances</span></span><br><span class="line"><span class="comment">     * receiving traffic during start ups.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apps</span></span><br><span class="line"><span class="comment">     *            The applications that needs to be filtered and shuffled.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The applications after the filter and the shuffle.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Applications <span class="title">filterAndShuffle</span><span class="params">(Applications apps)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</span><br><span class="line">                Map&lt;String, Applications&gt; remoteRegionVsApps = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Applications&gt;();</span><br><span class="line">                apps.shuffleAndIndexInstances(remoteRegionVsApps, clientConfig, instanceRegionChecker);</span><br><span class="line">                <span class="keyword">for</span> (Applications applications : remoteRegionVsApps.values()) &#123;</span><br><span class="line">                    applications.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.remoteRegionVsApps = remoteRegionVsApps;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                apps.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> apps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFetchingRemoteRegionRegistries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != remoteRegionsToFetch.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked when the remote status of this client has changed.</span></span><br><span class="line"><span class="comment">     * Subclasses may override this method to implement custom behavior if needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldStatus the previous remote &#123;<span class="doctag">@link</span> InstanceStatus&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newStatus the new remote &#123;<span class="doctag">@link</span> InstanceStatus&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRemoteStatusChanged</span><span class="params">(InstanceInfo.InstanceStatus oldStatus, InstanceInfo.InstanceStatus newStatus)</span> </span>&#123;</span><br><span class="line">        fireEvent(<span class="keyword">new</span> StatusChangeEvent(oldStatus, newStatus));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked every time the local registry cache is refreshed (whether changes have</span></span><br><span class="line"><span class="comment">     * been detected or not).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Subclasses may override this method to implement custom behavior if needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCacheRefreshed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fireEvent(<span class="keyword">new</span> CacheRefreshedEvent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send the given event on the EventBus if one is available</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the event to send on the eventBus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(<span class="keyword">final</span> EurekaEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (EurekaEventListener listener : eventListeners) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                listener.onEvent(event);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.info(<span class="string">"Event &#123;&#125; throw an exception for listener &#123;&#125;"</span>, event, listener, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see &#123;<span class="doctag">@link</span> com.netflix.appinfo.InstanceInfo#getZone(String[], com.netflix.appinfo.InstanceInfo)&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Get the zone that a particular instance is in.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> myInfo</span></span><br><span class="line"><span class="comment">     *            - The InstanceInfo object of the instance.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The zone in which the particular instance belongs to.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getZone</span><span class="params">(InstanceInfo myInfo)</span> </span>&#123;</span><br><span class="line">        String[] availZones = staticClientConfig.getAvailabilityZones(staticClientConfig.getRegion());</span><br><span class="line">        <span class="keyword">return</span> InstanceInfo.getZone(availZones, myInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> see replacement in &#123;<span class="doctag">@link</span> com.netflix.discovery.endpoint.EndpointUtils&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Get the region that this particular instance is in.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> - The region in which the particular instance belongs to.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRegion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String region = staticClientConfig.getRegion();</span><br><span class="line">        <span class="keyword">if</span> (region == <span class="keyword">null</span>) &#123;</span><br><span class="line">            region = <span class="string">"default"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        region = region.trim().toLowerCase();</span><br><span class="line">        <span class="keyword">return</span> region;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use &#123;<span class="doctag">@link</span> #getServiceUrlsFromConfig(String, boolean)&#125; instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getEurekaServiceUrlsFromConfig</span><span class="params">(String instanceZone, <span class="keyword">boolean</span> preferSameZone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EndpointUtils.getServiceUrlsFromConfig(staticClientConfig, instanceZone, preferSameZone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastSuccessfulHeartbeatTimePeriod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastSuccessfulHeartbeatTimestamp &lt; <span class="number">0</span></span><br><span class="line">                ? lastSuccessfulHeartbeatTimestamp</span><br><span class="line">                : System.currentTimeMillis() - lastSuccessfulHeartbeatTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastSuccessfulRegistryFetchTimePeriod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastSuccessfulRegistryFetchTimestamp &lt; <span class="number">0</span></span><br><span class="line">                ? lastSuccessfulRegistryFetchTimestamp</span><br><span class="line">                : System.currentTimeMillis() - lastSuccessfulRegistryFetchTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@com</span>.netflix.servo.annotations.Monitor(name = METRIC_REGISTRATION_PREFIX + <span class="string">"lastSuccessfulHeartbeatTimePeriod"</span>,</span><br><span class="line">            description = <span class="string">"How much time has passed from last successful heartbeat"</span>, type = DataSourceType.GAUGE)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getLastSuccessfulHeartbeatTimePeriodInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> delay = (!clientConfig.shouldRegisterWithEureka() || isShutdown.get())</span><br><span class="line">            ? <span class="number">0</span></span><br><span class="line">            : getLastSuccessfulHeartbeatTimePeriod();</span><br><span class="line"></span><br><span class="line">        heartbeatStalenessMonitor.update(computeStalenessMonitorDelay(delay));</span><br><span class="line">        <span class="keyword">return</span> delay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for metrics only</span></span><br><span class="line">    <span class="meta">@com</span>.netflix.servo.annotations.Monitor(name = METRIC_REGISTRY_PREFIX + <span class="string">"lastSuccessfulRegistryFetchTimePeriod"</span>,</span><br><span class="line">            description = <span class="string">"How much time has passed from last successful local registry update"</span>, type = DataSourceType.GAUGE)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getLastSuccessfulRegistryFetchTimePeriodInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> delay = (!clientConfig.shouldFetchRegistry() || isShutdown.get())</span><br><span class="line">            ? <span class="number">0</span></span><br><span class="line">            : getLastSuccessfulRegistryFetchTimePeriod();</span><br><span class="line"></span><br><span class="line">        registryStalenessMonitor.update(computeStalenessMonitorDelay(delay));</span><br><span class="line">        <span class="keyword">return</span> delay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@com</span>.netflix.servo.annotations.Monitor(name = METRIC_REGISTRY_PREFIX + <span class="string">"localRegistrySize"</span>,</span><br><span class="line">            description = <span class="string">"Count of instances in the local registry"</span>, type = DataSourceType.GAUGE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">localRegistrySize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> registrySize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">computeStalenessMonitorDelay</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delay &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() - initTimestampMs;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> delay;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/eco/" rel="tag"># eco</a>
          
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%8Cspringcloud/" rel="tag"># 微服务，springcloud</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/26/cloud/eureka-server-source-code/" rel="next" title="eureka-server-source-code">
                <i class="fa fa-chevron-left"></i> eureka-server-source-code
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/10/jm/jvm/" rel="prev" title="jvm">
                jvm <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jp"
                alt="HAOGRE" />
            
              <p class="site-author-name" itemprop="name">HAOGRE</p>
              <p class="site-description motion-element" itemprop="description">a hexo blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">662</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本功能"><span class="nav-number">1.</span> <span class="nav-text">基本功能</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HAOGRE</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
